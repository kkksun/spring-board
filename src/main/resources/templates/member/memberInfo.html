<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <link th:href="@{/css/boardStyle.css}"
          href="../css/boardStyle.css" rel="stylesheet">
    <script th:inline="javascript">

        let requestedPage = [[${requestedPage}]];
        let memberId = [[${memberId}]];
        let loginIdOfMember;
        let statusOfMember;

        document.addEventListener("DOMContentLoaded", function (){
            findMember("info");
        });

        const findMember = (page) => {

            fetch("/memberInfo/"+memberId)
                .then(response=> {
                    if (!response.ok) {
                        throw new Error('회원 정보가 존재하지 않습니다.');
                    }
                    return response.json();})
                .then(data => {
                    console.log(data)
                    Object.keys(data).forEach(key => {
                        if (document.getElementById(key) != undefined) {
                            document.getElementById(key).value = data[key]
                        }

                        if(page === "edit" && requestedPage === "MANAGE" && (key === "type" || key === "status")) {
                            document.querySelectorAll(`.${key}`).forEach((box) => {
                                if(box.value === data[key]) {
                                    box.checked = true;
                                }
                            })
                        }
                    })

                    if (page === "info"){
                        loginIdOfMember = data["loginId"];
                        statusOfMember = data["status"];
                    }

                })
                .catch(err => alert(err))
        }

       function changeInfo(pwChange) {
           let url = window.location.origin  + (requestedPage === "MEMBER"? "/member/" : "/manage/") + "edit/" + memberId + "?pwChange=" + pwChange;

            if(requestedPage === "MANAGE" && [[${session.loginMember.type}]] === "MANAGER" ) {
               alert("Manager는 회원 조회만 가능합니다.")
            } else if (statusOfMember === "DELETE") {
                alert("탈퇴한 계정은 수정 불가합니다.");
           } else {
                location.href = url;
            }
       }

        function deleteMember() {
            let reqUrl ="/member/delete/" + memberId + "?isMember=" + (requestedPage === "MEMBER"?  true : false);
            let url = window.location.origin;

            if(requestedPage === "MANAGE" && [[${session.loginMember.type}]] === "MANAGER" ) {
                alert("Manager는 회원 조회만 가능합니다.")
            } else if (loginIdOfMember === "admin") {
                alert("admin 계정은 탈퇴 불가합니다.");
            } else {
                if(confirm('탈퇴하시겠습니까?')) {
                    fetch(reqUrl, {
                        method : "DELETE"
                    }).then(response => {
                        if (response.ok) {
                            alert("탈퇴가 완료되었습니다.")
                            location.href = url + (requestedPage === "MEMBER"?  "" : "/manage/member")
                        } else {
                            throw new Error('회원 정보가 존재하지 않습니다.');
                        }
                    })
                }
            }
        }
    </script>
</head>
<body>
<div class="container">
    <div th:replace="~{fragment/topFrag :: topTitle ('회원 정보')}"></div>
    <div th:replace="~{fragment/topFrag :: menu ('NONE')}"></div><br>
    <div class="memberInfo"  id="form">
        <div>
            <label class="col">아이디</label>
            <input type="text" class="loginId" id="loginId" readonly>
        </div>
        <div>
            <label class="col">비밀번호</label>
            <div class="btn_p">
                <button class="pwChangeBtn"  type="button" th:onclick="changeInfo(true)">변경하기</button>
            </div>
        </div>
        <div>
            <label class="col">이름</label>
            <input type="text" class="userName" id="userName" readonly>
        </div>
        <div>
            <label class="col">이메일</label>
            <input type="text" class="email" id="email" readonly>
        </div>
        <div >
            <label class="col">유형</label>
            <input type="text" class="type" id="type" readonly>
        </div>
        <div th:if="${requestedPage} == 'MANAGE'">
            <label class="col">상태</label>
            <input type="text" class="status" id="status" readonly>
        </div>
        <div class="line"></div>
        <div class="row">
            <div class="btn">
                <button class="btn_e" th:onclick="changeInfo(false)" type="button">수정</button>
                <button class="btn_d" th:onclick="deleteMember()"  type="button">탈퇴</button>
            </div>
        </div>
    </div>
</div>
</body>
</html>